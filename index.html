<!doctype html>
<html lang="fi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>RUMAT STUDIO</title>

  <meta name="description" content="RUMAT STUDIO – ajattomia ja kestäviä kaavoja ja digiohjeita.">
  <link rel="icon" href="assets/favicon.ico">
  <link rel="preload" as="image" href="assets/hero.jpg">

  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
  <script>
    function getEmailCfg(){ return {
      PUBLIC_KEY:  localStorage.getItem('emailjs_public')  || '',
      SERVICE_ID:  localStorage.getItem('emailjs_service') || '',
      TEMPLATE_ID: localStorage.getItem('emailjs_template')|| ''
    }; }
    function setEmailCfg(pub,svc,tpl){ if(pub)localStorage.setItem('emailjs_public',pub); if(svc)localStorage.setItem('emailjs_service',svc); if(tpl)localStorage.setItem('emailjs_template',tpl); }
    window.configureEmailJS=function(){
      const cur=getEmailCfg();
      const pub=prompt('EmailJS Public Key',cur.PUBLIC_KEY||'')||'';
      const svc=prompt('EmailJS Service ID',cur.SERVICE_ID||'')||'';
      const tpl=prompt('EmailJS Template ID',cur.TEMPLATE_ID||'')||'';
      setEmailCfg(pub.trim(),svc.trim(),tpl.trim());
      const cfg=getEmailCfg(); if(window.emailjs&&cfg.PUBLIC_KEY){ try{ emailjs.init({publicKey:cfg.PUBLIC_KEY}); alert('EmailJS alustettu.'); }catch(e){ alert('EmailJS-alustus epäonnistui.'); } }
    };
    (function(){ const cfg=getEmailCfg(); if(window.emailjs&&cfg.PUBLIC_KEY){ try{ emailjs.init({publicKey:cfg.PUBLIC_KEY}); }catch{} }
      window.addEventListener('keydown',(e)=>{ if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='e'){ e.preventDefault(); window.configureEmailJS(); }});
    })();

    const CONSENT_KEY='cookieConsent.v1';
    function getConsent(){ try{return JSON.parse(localStorage.getItem(CONSENT_KEY)||'{}');}catch{return {}} }
    function setConsent(c){ localStorage.setItem(CONSENT_KEY,JSON.stringify(c||{})); }
    function enableAnalytics(){ console.log('Analytiikka päällä suostumuksella'); }
  </script>

  <style>
    :root{
      --ink:#202020; --olive:#A1A266; --deep-blue:#345563; --ivory:#F6F6F4; --light-blue:#DEEEEE;
      --header-h:64px; --band-radius:16px;

      /* Esittelypalkki */
      --intro-img-w: 360px;                                         /* kuvien leveys */
      --intro-img-h: clamp(620px, calc(100svh - 140px), 880px);     /* kuvien korkeus (ei veny kapealla) */
      --intro-gap:   16px;                                          /* väli kuviin ja tekstiin */
      --side-safe:   clamp(16px, 4vw, 32px);                        /* reunoihin turvaväli */
    }
    html{ scroll-padding-top: var(--header-h); }
    body{ font-family:Montserrat,system-ui,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--ivory); margin:0; overflow-x:hidden; }

    h1,h2,h3,h4,h5,h6{ font-weight:900!important; text-transform:uppercase; color:var(--deep-blue); letter-spacing:.02em; margin:0 0 .6rem; }
    .normalcase{ text-transform:none!important; }

    header{ background:var(--ivory); border-bottom:1px solid rgba(0,0,0,.08); }
    #hdrRow{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; }
    #brandText{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:min(42vw,460px); color:var(--ink); }
    #mainNav{ justify-self:center; display:flex; gap:1.5rem; white-space:nowrap; font-size:13px; text-transform:uppercase; letter-spacing:.2em; }
    #mainNav a{ color:var(--ink); text-decoration:none; }
    .nav-hidden{ display:none!important; } .nav-measure{ position:absolute!important; visibility:hidden!important; display:flex!important; white-space:nowrap!important; }
    #rightBlock{ justify-self:end; display:flex; align-items:center; gap:.5rem; white-space:nowrap; }
    .icon-btn{ position:relative; width:38px; height:38px; display:grid; place-items:center; border-radius:9999px; background:rgba(0,0,0,.06); border:1px solid rgba(0,0,0,.16); color:var(--ink); }
    .cart-text-btn{ border:1px solid rgba(0,0,0,.16); padding:.45rem .8rem; border-radius:9999px; color:var(--ink); background:rgba(0,0,0,.04); }
    .badge{ position:absolute; top:-4px; right:-4px; min-width:18px; height:18px; padding:0 4px; display:grid; place-items:center; border-radius:9999px; background:var(--ink); color:#fff; font-size:11px; font-weight:700; border:1px solid rgba(0,0,0,.15); }

    .btn{ border-radius:9999px; padding:.6rem 1rem; border:1px solid rgba(0,0,0,.16); background:rgba(0,0,0,.04); }
    .btn:hover{ background:rgba(0,0,0,.08); }

    .drawer{ position:fixed; inset:0; z-index:60; display:none; }
    .drawer.open{ display:block; }
    .drawer>.panel{ position:absolute; top:0; bottom:0; width:min(640px,94vw); background:var(--ivory); box-shadow:0 10px 30px rgba(0,0,0,.2); overflow:auto; }
    #menuDrawer .panel{ left:0; } #cartDrawer .panel{ right:0; } #checkoutDrawer .panel{ right:0; }

    .hero{ position:relative; height:calc(100svh - var(--header-h)); display:grid; place-items:center; overflow:hidden; text-align:center; background:#000; }
    .hero-img{ position:absolute; inset:0; width:100%; height:100%; object-fit:cover; object-position:center; z-index:0; }

    .svg-logo{ --logo-color:var(--ink); display:inline-block; width:6.5rem; height:6.5rem; background-color:var(--logo-color);
      -webkit-mask:url('assets/logo.svg') no-repeat center/contain; mask:url('assets/logo.svg') no-repeat center/contain; }
    .logo-light{ --logo-color:var(--light-blue); }
    .hero .svg-logo{ width:11rem; height:11rem; }
    .svg-logo--header{ width:2.8rem; height:2.8rem; }
    .svg-logo--footer{ width: clamp(120px,18vw,220px); height: clamp(120px,18vw,220px); }

    .band{ background:var(--ivory); border-radius:var(--band-radius); overflow:hidden; }
    .band-inner{ max-width:72rem; margin:0 auto; padding:3rem 1rem; }

    /* ===== ESITTELY – Wordin "neliö"-kääriytys ===== */
    .intro-wide{ margin-left:calc(50% - 50vw); margin-right:calc(50% - 50vw); }
    .intro-flow{ position:relative; padding-block:18px; padding-inline:var(--side-safe); }
    .intro-flow::after{ content:""; display:block; clear:both; }

    .intro-img{ width:var(--intro-img-w); height:var(--intro-img-h); background-size:cover; background-position:center; background-repeat:no-repeat; border:1px solid rgba(0,0,0,.12); }
    /* neliö-kääriytys: pelkkä float riittää (shape-outside ei pakollinen) */
    .intro-left{  float:left;  margin-right:var(--intro-gap);  margin-left:calc(-1 * var(--side-safe)); border-radius:0 18px 18px 0; }
    .intro-right{ float:right; margin-left:var(--intro-gap);   margin-right:calc(-1 * var(--side-safe)); border-radius:18px 0 0 18px; }

    .intro-copy{ margin:0; max-width:none; padding-inline: clamp(8px,1.6vw,16px); overflow:visible; }
    .intro-copy .logo{ width:56px; height:56px; display:block; margin:0 auto 12px; object-fit:contain; }
    .intro-copy p{ margin:0 0 .8rem; line-height:1.6; }

    @media (max-width:900px){
      .intro-img{ width:100%; height:min(72vh,640px); float:none; margin:0; border-radius:12px; }
      .intro-left{  margin-bottom:12px; margin-left:0; }
      .intro-right{ margin-top:12px!important; margin-right:0; }
      .intro-copy{ padding-inline:2px; }
    }

    .card{ background:var(--ivory); border-radius:16px; border:1px solid rgba(0,0,0,.12); overflow:hidden; }
    .pattern-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    @media (min-width:768px){ .pattern-grid{ grid-template-columns:repeat(4,minmax(0,1fr)); gap:14px; } }
    .tile{ position:relative; cursor:pointer; aspect-ratio:1/1; }
    .tile img{ width:100%; height:100%; object-fit:cover; display:block; }
    .tile-caption{ position:absolute; left:0; right:0; bottom:0; padding:.45rem .65rem; background:linear-gradient(to top,rgba(0,0,0,.55),rgba(0,0,0,0)); color:#fff; font-weight:800; letter-spacing:.06em; text-transform:uppercase; font-size:.85rem; }
    .tile--selected{ outline:2px solid var(--deep-blue); }
    .expander{ grid-column:1/-1; border:1px solid rgba(0,0,0,.12); border-radius:16px; overflow:hidden; }
    .ex-row{ display:grid; grid-template-columns:1fr; }
    @media (min-width:1024px){ .ex-row{ grid-template-columns:minmax(0,1.6fr) minmax(0,1fr); } }
    .ex-view{ position:relative; background:#000; min-height:min(80vh,1600px); }
    .ex-view img{ width:100%; height:100%; object-fit:contain; background:#000; }
    .ex-prev,.ex-next{ position:absolute; top:50%; transform:translateY(-50%); width:42px; height:42px; display:grid; place-items:center; border-radius:9999px; background:var(--ivory); border:1px solid rgba(0,0,0,.15); font-weight:800; }
    .ex-prev{ left:10px; } .ex-next{ right:10px; }

    .footer-bar{ background:var(--olive); color:var(--ink); }
    .footer-grid{ max-width:72rem; margin:0 auto; padding:1.5rem 1rem; display:grid; gap:1rem 2rem; grid-template-columns:1fr 1fr 1fr; grid-template-areas:"social contact logo"; }
    .footer-social{ grid-area:social; display:flex; flex-direction:column; gap:.9rem; }
    .footer-contact{ grid-area:contact; display:flex; flex-direction:column; gap:.9rem; }
    .footer-logoBox{ grid-area:logo; display:flex; justify-content:flex-end; align-items:flex-start; }
    .footer-copy{ text-align:center; font-size:.85rem; opacity:.85; padding:10px 1rem 16px; }
    @media (max-width:860px){ .footer-grid{ grid-template-columns:1fr 1fr; grid-template-areas:"contact logo" "social logo"; } .footer-logoBox{ justify-content:center; } }

    .toast{ position:fixed; top:76px; left:0; right:0; display:flex; justify-content:center; z-index:70; pointer-events:none; }
    .toast>div{ pointer-events:auto; }

    #cookieBanner{ position:fixed; z-index:80; left:0; right:0; bottom:0; display:none; }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="fixed top-0 left-0 right-0 z-50">
    <div id="hdrRow" class="mx-auto max-w-6xl px-4 py-4">
      <a id="brandBlock" href="#etusivu" aria-label="Etusivu" class="flex items-center gap-3 min-w-0">
        <span class="svg-logo svg-logo--header logo-light" role="img" aria-label="RUMAT STUDIO"></span>
        <span id="brandText" class="uppercase text-sm tracking-widest"><span class="font-black">RUMAT</span>&nbsp;<span class="font-semibold">STUDIO</span></span>
      </a>
      <nav id="mainNav" class="justify-self-center">
        <a href="#mikaonrumat"  class="hover:underline underline-offset-4">Mikä on RUMAT?</a>
        <a href="#kaaviot"      class="hover:underline underline-offset-4">Kaavat</a>
        <a href="#suunnittelija"class="hover:underline underline-offset-4">Suunnittelija</a>
        <a href="#yhteys"       class="hover:underline underline-offset-4">Ota yhteyttä</a>
      </nav>
      <div id="rightBlock" class="flex items-center gap-2">
        <button id="openMenu" class="icon-btn hidden" aria-controls="menuDrawer" aria-expanded="false" aria-label="Valikko">
          <span aria-hidden="true" style="font-size:20px;line-height:1">☰</span><span class="sr-only">Valikko</span>
        </button>
        <button id="openCartText" class="cart-text-btn">Ostoskori <span id="cartCountText" class="opacity-80"></span></button>
        <button id="openCartIcon" class="icon-btn hidden" aria-label="Ostoskori">
          <svg aria-hidden="true" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="20" r="1.8"></circle><circle cx="17" cy="20" r="1.8"></circle><path d="M3 4h2l2.2 10.2a2 2 0 0 0 2 1.6h7.7a2 2 0 0 0 2-1.6L21 8H7.1"></path></svg>
          <span class="badge" id="cartCount">0</span>
        </button>
      </div>
    </div>
  </header>

  <div id="toast" class="toast"></div>

  <main class="pt-[64px]">
    <!-- HERO -->
    <section id="etusivu" class="hero px-4">
      <img src="assets/hero.jpg" alt="RUMAT STUDIO hero" class="hero-img" onerror="this.onerror=null;this.src='assets/placeholder.jpg';">
      <span class="svg-logo logo-light" role="img" aria-label="RUMAT STUDIO"></span>
    </section>

    <!-- Esittely -->
    <section id="mikaonrumat" class="py-0">
      <div class="band full-bleed">
        <div class="band-inner">
          <h2 class="mb-4">Liian rumat ollakseen totta</h2>

          <div class="intro-wide">
            <div class="intro-flow" id="introFlow">
              <!-- Vasen kuva, aina ylhäällä -->
              <div class="intro-img intro-left" id="introLeft" style="background-image:url('assets/intro-left.jpg')"></div>

              <!-- Teksti + oikea kuva (oikea siirretään kappaleiden väliin JS:llä) -->
              <div class="intro-copy" id="introCopy">
                <img class="logo" src="assets/logo.svg" alt="RUMAT STUDIO" onerror="this.onerror=null;this.src='assets/placeholder.jpg'">
                <div id="intro-text" class="text-[15px] sm:text-base normalcase"></div>

                <!-- Oikea kuva (float:right) – JS sijoittaa ennen sopivaa kappaletta -->
                <div class="intro-img intro-right" id="introRight" style="background-image:url('assets/intro-right.jpg')"></div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- Kaaviot -->
    <section id="kaaviot" class="py-0">
      <div class="band full-bleed">
        <div class="band-inner">
          <h2 class="text-3xl mb-4">Kaavat</h2>
          <div id="patternsGrid" class="pattern-grid"></div>
        </div>
      </div>
    </section>

    <!-- Suunnittelija -->
    <section id="suunnittelija" class="py-0">
      <div class="band full-bleed">
        <div class="band-inner">
          <h2 class="text-3xl mb-4">Suunnittelija</h2>
          <div class="grid md:grid-cols-[320px_1fr] gap-6 items-start">
            <div><img src="assets/designer.jpg" onerror="this.onerror=null;this.src='assets/placeholder.jpg';" alt="Suunnittelija" class="rounded-xl border border-[rgba(0,0,0,.12)] object-cover w-full h-[300px] md:h-[420px]"></div>
            <div class="space-y-4 normalcase"><p>Aaltonen on itsevarma neuloja...</p><p>Pian Aaltonen valmistuu taiteen maisteriksi...</p></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Footer -->
    <footer id="yhteys" class="footer-bar">
      <div class="footer-grid">
        <div class="footer-social">
          <div class="footer-col"><h6>Instagram</h6><a class="footer-handle" href="https://instagram.com/rumat.studio" target="_blank" rel="noreferrer">rumat.studio</a></div>
          <div class="footer-col"><h6>TikTok</h6><a class="footer-handle" href="https://www.tiktok.com/@rumat.studio" target="_blank" rel="noreferrer">rumat.studio</a></div>
        </div>
        <div class="footer-contact">
          <div class="footer-col"><h6>Ota yhteyttä</h6><a class="footer-link" href="mailto:aaltonen96@outlook.com">aaltonen96@outlook.com</a></div>
          <div class="footer-col"><div class="footer-ytunnus">Y-3436822-5</div>
            <div class="mt-2 flex flex-col gap-1 text-sm">
              <a class="footer-link" href="legal/privacy.html" target="_blank" rel="noopener">Tietosuojaseloste (PDF)</a>
              <a class="footer-link" href="legal/terms.html" target="_blank" rel="noopener">Toimitus- ja sopimusehdot (PDF)</a>
              <a class="footer-link" href="#" id="openCookiePrefs">Evästeasetukset</a>
            </div>
          </div>
        </div>
        <div class="footer-logoBox"><span class="svg-logo svg-logo--footer logo-light" role="img" aria-label="RUMAT STUDIO"></span></div>
      </div>
      <div class="footer-copy">© <span id="year"></span> RUMAT STUDIO</div>
    </footer>
  </main>

  <!-- OSTOSKORI + KASSA + VALIKKO (sama logiikka kuin aiemmin, lyhennettynä vain ostoskorin avaamiseksi) -->
  <div id="cartDrawer" class="drawer" aria-hidden="true">
    <div class="absolute inset-0 bg-black/40" id="closeCart"></div>
    <div class="panel p-5 flex flex-col">
      <div class="flex items-center justify-between mb-4"><h3 class="text-xl">Ostoskori</h3><button id="closeCartX">✕</button></div>
      <div id="cartItems" class="flex-1 overflow-auto divide-y"></div>
      <div class="mt-4 space-y-3">
        <div class="text-sm grid grid-cols-2 gap-y-1"><div class="text-stone-600">Välisumma</div><div id="subTotal" class="text-right">€0,00</div></div>
        <button id="checkout" class="btn bg-[color:var(--deep-blue)] text-white">Kassalle</button>
        <div id="paypalWarn" class="text-xs text-stone-600"></div>
      </div>
    </div>
  </div>

  <div id="menuDrawer" class="drawer" aria-hidden="true">
    <div class="absolute inset-0 bg-black/40" id="closeMenu"></div>
    <div class="panel p-6 flex flex-col gap-4">
      <div class="flex items-center justify-between"><h3 class="text-xl">Valikko</h3><button id="closeMenuX">✕</button></div>
      <nav class="flex flex-col gap-3 text-lg">
        <a href="#mikaonrumat"  class="py-2 border-b" data-menu-close>Mikä on RUMAT?</a>
        <a href="#kaaviot"      class="py-2 border-b" data-menu-close>Kaavat</a>
        <a href="#suunnittelija"class="py-2 border-b" data-menu-close>Suunnittelija</a>
        <a href="#yhteys"       class="py-2"          data-menu-close>Ota yhteyttä</a>
      </nav>
    </div>
  </div>

  <script>
  const fmtEUR = x => new Intl.NumberFormat('fi-FI',{style:'currency',currency:'EUR'}).format(x);
  const $ = s => document.querySelector(s);
  const el=(t,a={},...k)=>{ const n=document.createElement(t); Object.entries(a).forEach(([k2,v])=>{
    if(k2==='class') n.className=v; else if(k2==='html') n.innerHTML=v; else if(k2.startsWith('on')) n.addEventListener(k2.slice(2),v); else n.setAttribute(k2,v);
  }); k.forEach(c=>{ if(c==null) return; n.appendChild(typeof c==='string'?document.createTextNode(c):c);}); return n; };
  (function(){ const y=document.getElementById('year'); if(y) y.textContent=new Date().getFullYear(); })();

  // Esittelyteksti sisään
  function parasToHTML(s){ return String(s||'').trim().split(/\n\s*\n/).map(p=>`<p>${p.trim()}</p>`).join('\n'); }
  const defaultContent={ pitch:`RUMAT STUDIO syntyi lapsuuden haaveesta... 

RUMAT STUDIO pohjautuu vahvaan arvopohjaan...

Taustalla on halu luoda ajattomia...

Tulevaisuuden suunnitelmissa on oman studiollisen avaaminen...

Jokainen “liian RUMAT ollakseen totta” -tuote on suunniteltu huolella...` };
  (function(){ const intro=document.getElementById('intro-text'); if(intro) intro.innerHTML=parasToHTML(defaultContent.pitch); })();

  // ===== OIKEAN KUVAN SIJOITTELU KAPPALEIDEN VÄLIIN =====
  function placeRightImage(){
    const copy = document.getElementById('introCopy');
    const right = document.getElementById('introRight');
    if(!copy||!right) return;

    // Mobiilissa ei sijoittelua
    if (window.matchMedia('(max-width:900px)').matches){ copy.appendChild(right); right.style.marginTop='12px'; return; }

    // varmista että oikea kuva on copy-divissä
    if(right.parentNode!==copy) copy.appendChild(right);

    // mittaa oikean kuvan korkeus (CSS asettaa)
    right.style.visibility='hidden';
    right.style.float='right';
    right.style.marginTop='0px';
    const h = right.getBoundingClientRect().height || parseFloat(getComputedStyle(right).height);
    right.style.visibility='';

    // Kohdetaite: haluamme, että kuvan alareuna ~ tekstin alareunan tasalla
    const targetTop = Math.max(0, copy.scrollHeight - h);

    // Etsi kappale, jonka kohdalla kuvan kannattaa alkaa
    const paras = Array.from(copy.querySelectorAll('#intro-text > p'));
    let before = null;
    for(const p of paras){
      const top = p.offsetTop;
      const bottom = top + p.offsetHeight;
      if (bottom >= targetTop){ before = p; break; }
    }
    if (before){ copy.insertBefore(right, before); }
    else { copy.appendChild(right); }

    right.style.marginTop = '0px'; // ei ylimääräistä siirtoa
  }
  window.addEventListener('load', placeRightImage);
  window.addEventListener('resize', ()=>requestAnimationFrame(placeRightImage), {passive:true});
  if('fonts' in document) document.fonts.ready.then(placeRightImage);
  new ResizeObserver(()=>placeRightImage()).observe(document.getElementById('introCopy'));

  // ---------- Tuotteet ----------
  const IMG=(id,n=1)=>`assets/patterns/${id}-${n}.jpg`;
  window.KAAVIOT=[
    { id:'dummy-kaava', name:'Dummy kaava', price:0.01, sizes:'PDF', blurb:'Väliaikainen testikaava…', images:[IMG('dummy-kaava',1),IMG('dummy-kaava',2)], isDummy:true, deliverable:true, file:'auto-dummy' },
    { id:'ilmainen-ohje', name:'Ilmainen ohje', price:0, sizes:'One size', blurb:'Ilmainen ohje (dummy-PDF).', images:[IMG('ilmainen-ohje',1)], deliverable:true, file:'auto-dummy' },
    { id:'takki', name:'Takki', price:0.01, sizes:'XS–XL', blurb:'Työn alla – pian saatavilla.', images:[IMG('takki',1)], deliverable:false },
    { id:'laukku', name:'Laukku', price:0.01, sizes:'One size', blurb:'Sling-laukku.', images:[IMG('laukku',1)], deliverable:false },
    { id:'usva-paita', name:'Usva paita', price:0.01, sizes:'XS–XL', blurb:'Rento paita.', images:[IMG('usva-paita',1)], deliverable:false },
  ];

  let CART=JSON.parse(localStorage.getItem('cart')||'{}');
  function saveCart(){ localStorage.setItem('cart',JSON.stringify(CART)); updateBadge(); }
  function updateBadge(){ const n=Object.values(CART).reduce((a,b)=>a+b,0); const ic=$('#cartCount'); const tx=$('#cartCountText'); if(ic) ic.textContent=String(n); if(tx) tx.textContent=n?`(${n})`:''; }
  function openCart(){ $('#cartDrawer').classList.add('open'); renderCart(); }
  function closeCart(){ $('#cartDrawer').classList.remove('open'); }
  $('#openCartText')?.addEventListener('click',openCart); $('#openCartIcon')?.addEventListener('click',openCart);
  $('#closeCart')?.addEventListener('click',closeCart); $('#closeCartX')?.addEventListener('click',closeCart);

  function renderCart(){
    const root=$('#cartItems'); root.innerHTML=''; let sub=0;
    Object.entries(CART).forEach(([id,q])=>{
      const p=window.KAAVIOT.find(x=>x.id===id); if(!p) return; sub+=(p.price||0)*q;
      root.appendChild(el('div',{class:'py-3 flex items-center justify-between gap-3'},
        el('div',{}, el('div',{class:'font-semibold'},p.name), el('div',{class:'text-sm opacity-70'},fmtEUR(p.price||0))),
        el('div',{}, el('button',{'data-remove':id,class:'px-2 border rounded'},'Poista'))
      ));
    });
    $('#subTotal').textContent=fmtEUR(sub);
    root.querySelectorAll('[data-remove]').forEach(b=>b.onclick=()=>{ delete CART[b.dataset.remove]; saveCart(); renderCart(); });
  }
  function addToCart(id){ const p=window.KAAVIOT.find(x=>x.id===id); if(!p) return;
    if(!(p.deliverable||p.isDummy||p.file)) return alert('Tuote on tulossa – ei vielä ostettavissa.');
    CART[id]=(CART[id]||0)+1; saveCart(); openCart();
  }
  window.addToCart=addToCart; updateBadge();

  // Malli kaavioruudukko + expander (ostopainike = Lisää ostoskoriin)
  (function(){
    const grid=document.getElementById('patternsGrid'); let exp=null, cur=null, idx=0;
    function safeImg(src,alt){ const i=new Image(); i.alt=alt||''; i.loading='lazy'; i.src=src||'assets/placeholder.jpg'; i.onerror=()=>i.src='assets/placeholder.jpg'; return i; }
    window.KAAVIOT.forEach(p=>{
      const a=document.createElement('article'); a.className='tile card'; a.dataset.id=p.id;
      a.appendChild(safeImg((p.images||[])[0],p.name));
      const cap=document.createElement('div'); cap.className='tile-caption';
      cap.textContent=p.name + (p.deliverable||p.isDummy||p.file ? (p.price===0?' · Ilmainen':'') : ' · Tulossa');
      a.appendChild(cap); grid.appendChild(a);
    });
    function cols(){ const cs=getComputedStyle(grid).gridTemplateColumns; return Math.max(1,cs.split(' ').length); }
    function insertAfterRow(tile){ const tiles=[...grid.querySelectorAll('.tile, .expander')]; const only=tiles.filter(x=>x.classList.contains('tile')); const i=only.indexOf(tile); const c=cols(); const end=Math.min(only.length-1, Math.floor(i/c)*c+(c-1)); const after=only[end]; grid.insertBefore(exp, after.nextSibling); }
    function build(){ exp=document.createElement('div'); exp.className='expander'; exp.innerHTML=`<div class="ex-top"><div id="exTitle" class="font-semibold"></div><button id="exClose" class="px-3 py-1 rounded border">pienennä</button></div>
      <div class="ex-row"><div class="ex-view"><img id="exImg"><button id="exPrev" class="ex-prev">◀</button><button id="exNext" class="ex-next">▶</button></div>
      <div class="ex-info"><h3 id="exName" class="text-2xl mb-2"></h3><p id="exBlurb" class="opacity-80 mb-2 normalcase"></p>
      <div class="mb-2"><span class="font-semibold">Koot: </span><span id="exSizes"></span></div><div id="exPrice" class="text-xl font-bold mb-4"></div><div id="exActions"></div></div></div>`;
      exp.querySelector('#exPrev').onclick=()=>nav(-1); exp.querySelector('#exNext').onclick=()=>nav(1); exp.querySelector('#exClose').onclick=()=>{ exp.remove(); cur=null; };
    }
    build();
    function openFor(p,tile){ cur=p; idx=0;
      exp.querySelector('#exTitle').textContent=p.name;
      exp.querySelector('#exName').textContent=p.name;
      exp.querySelector('#exBlurb').textContent=p.blurb||'';
      exp.querySelector('#exSizes').textContent=p.sizes||'';
      exp.querySelector('#exPrice').textContent=p.price===0?'ILMAINEN':fmtEUR(p.price||0);
      exp.querySelector('#exImg').src=(p.images||[])[0]||'assets/placeholder.jpg';
      const act=exp.querySelector('#exActions'); act.innerHTML='';
      if(!(p.deliverable||p.isDummy||p.file)){ act.textContent='Tulossa'; act.className='inline-block px-4 py-2 rounded-full border'; }
      else{
        const b=document.createElement('button');
        b.className='btn bg-[color:var(--deep-blue)] text-white'; b.textContent=p.price===0?'Lisää ostoskoriin (0,00 €)':'Lisää ostoskoriin';
        b.onclick=()=>addToCart(p.id); act.appendChild(b);
      }
      insertAfterRow(tile);
    }
    function nav(d){ if(!cur) return; const arr=cur.images||[]; if(!arr.length) return; idx=(idx+d+arr.length)%arr.length; exp.querySelector('#exImg').src=arr[idx]; }
    grid.addEventListener('click',(e)=>{ const t=e.target.closest('.tile'); if(!t) return; if(!exp.parentNode) grid.appendChild(exp); openFor(window.KAAVIOT.find(x=>x.id===t.dataset.id),t); });
    window.addEventListener('resize',()=>{ if(cur&&exp.parentNode){ const t=[...grid.querySelectorAll('.tile')].find(x=>x.dataset.id===cur.id); if(t) insertAfterRow(t); }},{passive:true});
  })();

  // header nav show/hide
  (function(){
    const container=document.getElementById('hdrRow'), brand=document.getElementById('brandBlock'), nav=document.getElementById('mainNav'), right=document.getElementById('rightBlock'), menuBtn=document.getElementById('openMenu'), cartIcon=document.getElementById('openCartIcon'), cartText=document.getElementById('openCartText');
    let navVisible=true; const GAP=72;
    function measure(){ const was=nav.classList.contains('nav-hidden'); if(was) nav.classList.remove('nav-hidden'); nav.classList.add('nav-measure'); const w=Math.ceil(nav.scrollWidth); nav.classList.remove('nav-measure'); if(was) nav.classList.add('nav-hidden'); return w; }
    function canShow(){ const cw=container.clientWidth; const bw=Math.ceil(brand.getBoundingClientRect().width); const rw=Math.ceil(right.getBoundingClientRect().width); return measure()<=Math.max(0,cw-bw-rw-GAP); }
    function apply(show){ navVisible=!!show; if(show){ nav.classList.remove('nav-hidden'); menuBtn.classList.add('hidden'); cartIcon.classList.add('hidden'); cartText.classList.remove('hidden'); }else{ nav.classList.add('nav-hidden'); menuBtn.classList.remove('hidden'); cartIcon.classList.remove('hidden'); cartText.classList.add('hidden'); } }
    function compute(){ if(navVisible){ if(!canShow()) apply(false);} else { if(canShow()) apply(true);} }
    let t=null; const schedule=()=>{ if(t) return; t=setTimeout(()=>{ t=null; compute(); },80); };
    window.addEventListener('resize',schedule,{passive:true}); if('fonts' in document) document.fonts.ready.then(compute); compute();

    const drawer=document.getElementById('menuDrawer'); const openBtn=document.getElementById('openMenu'); const closeA=document.getElementById('closeMenu'); const closeX=document.getElementById('closeMenuX');
    function open(){ drawer.classList.add('open'); openBtn.setAttribute('aria-expanded','true'); }
    function close(){ drawer.classList.remove('open'); openBtn.setAttribute('aria-expanded','false'); }
    openBtn.addEventListener('click',open); closeA?.addEventListener('click',close); closeX?.addEventListener('click',close);
    drawer.addEventListener('click',e=>{ if(e.target===drawer) close(); }); document.addEventListener('keydown',e=>{ if(e.key==='Escape') close(); });
    drawer.querySelectorAll?.('[data-menu-close]')?.forEach(a=>a.addEventListener('click',close));
  })();
  </script>
</body>
</html>
